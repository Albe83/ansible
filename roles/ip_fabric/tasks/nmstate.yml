---
# tasks/nmstate.yml
# Tutto ci√≤ che riguarda nmstate: install, config, render dei file e avvio del servizio.

- name: Ensure nmstate package is installed
  package:
    name: nmstate
    state: present
  become: true

- name: Ensure NetworkManager is running (nmstate requires it)
  service:
    name: NetworkManager
    state: started
    enabled: true
  become: true

- name: Ensure nmstate config directory exists
  file:
    path: /etc/nmstate
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Configure nmstate service options
  copy:
    dest: /etc/nmstate/nmstate.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      [service]
      keep_state_file_after_apply = true
  become: true

# ---------- RENDER DEGLI STATE FILE ----------

- name: Render loopback0 NMState file
  template:
    src: ip_fabric_node.yml.j2
    dest: /etc/nmstate/ip_fabric_node.yml
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Render fabric NMState files (blue/green)
  loop: "{{ ip_fabric_node.fabrics }}"
  loop_control:
    loop_var: fabric
  template:
    src: nm_fabric_iface.yaml.j2
    dest: "/etc/nmstate/ip-fabric-{{ fabric.name }}.yml"
    owner: root
    group: root
    mode: '0644'
  become: true

# ---------- AVVIO / RIAPPLICAZIONE ----------

- name: Enable nmstate.service so configs are applied on every boot
  service:
    name: nmstate
    enabled: true
  become: true