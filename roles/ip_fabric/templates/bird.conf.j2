# BIRD v3 configuration for IP Fabric underlay (OSPF)
# This file is managed by Ansible. Do not edit manually.

log syslog all;
log stderr all;

router id {{ ip_fabric_node.node.address }};

protocol device {
  scan time 10;
}

protocol kernel kernel4 {
  ipv4 {
    import all;
    export where proto = "ospf_underlay_v2";
  };
  scan time 20;
}

protocol direct direct4 {
  ipv4;
}

protocol ospf v2 ospf_underlay_v2 {

  ipv4 {
    import all;
    export none;
  };

  {% for fabric in ip_fabric_node.fabrics %}
  area {{ ip_fabrics[fabric.name].igp.ospf.area | default(ip_fabrics[fabric.name].prefix.address) }} {
    interface {{ ip_fabrics[fabric.name].prefix.address }}/{{ ip_fabrics[fabric.name].prefix.length }} {
      hello 1; # Send Hello Packet every 1s
      dead 2; # Peer is gone after 2s
      {% if fabric.role == "leaf" -%}
      priority 0; # Isn't eligible for DR/BDR role
      {% endif %}
    };

    # Announce Node address to the Fabric
    stubnet {{ ip_fabric_node.node.address }}/{{ ip_fabric_node.node.length }};

  };
  {% endfor %}
}
