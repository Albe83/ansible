# BIRD v3 configuration for IP Fabric underlay (OSPF)
# This file is managed by Ansible. Do not edit manually.

log syslog all;
log stderr all;

router id {{ ip_fabric_node.node.address }};

protocol device {
  scan time 10;
}

protocol kernel kernel4 {
  ipv4 {
    import all;
    export where proto = "ospf_underlay_v2";
  };
  scan time 20;
}

protocol direct direct4 {
  ipv4;
}

protocol bfd {
  {% for fabric in ip_fabric_node.fabrics %}
  interface "{{ fabric.network.interface }}" {
    interval {{ ip_fabrics[fabric.name].bfd.interval | default("300 ms") }};
    multiplier {{ ip_fabrics[fabric.name].bfd.multiplier | default("3") }};
  };
  {% endfor %}
}

protocol ospf v2 ospf_underlay_v2 {

  ipv4 {
    import all;
    export none;
  };

  area 0 {
    # Node Fabric
    interface {{ ip_fabric_node.node.address }} {
      stub on;
      priority 0;
    };

    {% for fabric in ip_fabric_node.fabrics %}
    # Fabric {{ fabric.name }}
    interface {{ fabric.network.address }} {
      hello 1;  # Send Hello Packet every 1s
      dead 2;   # Peer is gone after 2s
      {% if fabric.role == "leaf" %}
      priority 0;  # Isn't eligible for DR/BDR role
      {% endif %}
      {% if ip_fabrics[fabric.name].bfd.enabled %}
      bfd on;
      {% else %}
      bfd off;
      {% endif %}
    };
    {% endfor %}

  };
}